name: Publish Docker Image on Main

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  call-reusable-build:
    name: Build and Push Main Image
    # 使用可复用工作流
    uses: ./.github/workflows/reusable-build.yml
    with:
      # 生成镜像标签：一个基于分支名，一个基于 commit SHA
      tags: |
        ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
        ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
      push: true
    secrets:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}