name: 🚀 Release Docker Publisher

on:
  release:
    types: [published]
  workflow_dispatch:

run-name: 🚀 Publish Release ${{ github.event.release.tag_name }}

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  call-reusable-build:
    name: Build and Push Release Image
    permissions:
      contents: read
      packages: write
    # 使用可复用工作流
    uses: ./.github/workflows/reusable-build.yml
    with:
      # 生成镜像标签：一个基于 release tag，一个标记为 latest
      tags: |
        ghcr.io/${{ github.repository }}:${{ github.event.release.tag_name }}
        ghcr.io/${{ github.repository }}:latest
      push: true
      # 发布版本构建多架构支持
      build_arm64: true
    secrets:
      DOCKER_REGISTRY_TOKEN: ${{ secrets.GITHUB_TOKEN }}